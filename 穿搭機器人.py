# -*- coding: utf-8 -*-
"""ç©¿æ­æ©Ÿå™¨äºº.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1lMGdncSoJNw5DQH84tJCxzk47tJ19GZE
"""

import requests
import math
import concurrent.futures
from datetime import datetime
import streamlit as st

# API è¨­å®š
API_HUMAN = "https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0003-001?Authorization=CWA-4E0D8035-5999-4578-85B2-6E61AD206449&downloadType=WEB&format=JSON"
API_AUTO = "https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0001-001?Authorization=CWA-4E0D8035-5999-4578-85B2-6E61AD206449&downloadType=WEB&format=JSON"
API_RAIN = "https://opendata.cwa.gov.tw/fileapi/v1/opendataapi/O-A0002-001?Authorization=CWA-4E0D8035-5999-4578-85B2-6E61AD206449&downloadType=WEB&format=JSON"

def get_weather_data(url):
    try:
        response = requests.get(url, timeout=5)
        response.raise_for_status()
        return response.json()['cwaopendata']['dataset']['Station']
    except:
        return []

def fetch_all_data():
    with concurrent.futures.ThreadPoolExecutor() as executor:
        f1 = executor.submit(get_weather_data, API_HUMAN)
        f2 = executor.submit(get_weather_data, API_AUTO)
        f3 = executor.submit(get_weather_data, API_RAIN)
        return f1.result() + f2.result(), f3.result()

def format_time(dt_str):
    try:
        dt = datetime.fromisoformat(dt_str.replace("Z", "+00:00"))
        return dt.strftime("%Y-%m-%d %H:%M")
    except:
        return "æœªçŸ¥æ™‚é–“"

def calculate_vapor_pressure(temp, rh):
    es = 6.112 * math.exp((17.67 * temp) / (temp + 243.5))
    return es * (rh / 100)

def calculate_feels_like(temp, vapor_pressure, wind):
    return 1.04 * temp + 0.2 * vapor_pressure - 0.65 * wind - 2.7

def get_outfit_suggestion(temp, rain, wind):
    try:
        temp = float(temp)
        rain = float(rain) if rain != "ç„¡è³‡æ–™" else 0
        wind = float(wind)
    except:
        return "ç„¡æ³•æä¾›ç©¿æ­å»ºè­°"

    suggestion = ""
    if temp >= 30:
        suggestion = "çŸ­è¢–çŸ­è¤²ï¼Œæ³¨æ„é˜²æ›¬ â˜€ï¸"
    elif temp >= 20:
        suggestion = "è–„é•·è¢–æˆ– T-shirtï¼Œæ—©æ™šæ¶¼ ğŸ§¥"
    elif temp >= 10:
        suggestion = "å»ºè­°å¤–å¥—ã€é¢¨è¡£ ğŸ§£"
    else:
        suggestion = "æ¯›è¡£ã€åšå¤–å¥—ã€å¸½å­ ğŸ§¤"

    if rain >= 1:
        suggestion += "ï¼Œè¨˜å¾—å¸¶é›¨å…· â˜”"

    if wind >= 6:
        suggestion += "ï¼Œé¢¨å¤§æ³¨æ„ä¿æš– ğŸŒ¬ï¸"

    return suggestion

def get_weather_and_suggestion(city, town):
    stations, rain_stations = fetch_all_data()
    weather_info = "âŒ æ‰¾ä¸åˆ°æ°£è±¡è³‡è¨Š"
    outfit = "ç„¡æ³•å»ºè­°ç©¿æ­"
    selected_station = None
    note=" "

    for station in stations:
        if station['GeoInfo']['CountyName'] == city and station['GeoInfo']['TownName'] == town:
            selected_station = station
            break

    if not selected_station:
        for station in stations:
            if station['GeoInfo']['CountyName'] == city:
                selected_station = station
                note = "âš ï¸ æ‰¾ä¸åˆ°æŒ‡å®šè¡Œæ”¿å€çš„æ¸¬ç«™ï¼Œé¡¯ç¤ºæœ€è¿‘çš„æ¸¬ç«™è³‡æ–™ã€‚\n"
                break

    if selected_station:
        elem = selected_station.get('WeatherElement', {})
        temp = elem.get('AirTemperature', "ç„¡è³‡æ–™")
        humd = elem.get('RelativeHumidity', "ç„¡è³‡æ–™")
        wind = elem.get('WindSpeed', "ç„¡è³‡æ–™")
        rain = "ç„¡è³‡æ–™"
        time = format_time(selected_station.get('ObsTime', {}).get('DateTime', ""))

        rain_station = next(
            (r for r in rain_stations if r['GeoInfo']['CountyName'] == selected_station['GeoInfo']['CountyName'] and
             r['GeoInfo']['TownName'] == selected_station['GeoInfo']['TownName']), None)
        if rain_station:
            rain_elem = rain_station.get('WeatherElement', {}).get('Now', {})
            rain = rain_elem.get('Precipitation', "ç„¡è³‡æ–™")

        try:
            temp_f = float(temp)
            humd_f = float(humd)
            wind_f = float(wind)
            vapor_p = calculate_vapor_pressure(temp_f, humd_f)
            feel_temp = calculate_feels_like(temp_f, vapor_p, wind_f)
            feel_temp_str = f"{feel_temp:.1f}Â°C"
        except:
            feel_temp_str = "ç„¡æ³•è¨ˆç®—"


        weather_info = note + f"""
ğŸ“ æ¸¬ç«™åœ°é»ï¼š{selected_station['GeoInfo']['CountyName']} {selected_station['GeoInfo']['TownName']}
ğŸŒ¡ï¸ æ°£æº«ï¼š{temp}Â°Cï¼ˆé«”æ„Ÿï¼š{feel_temp_str}ï¼‰
ğŸ’§ æ¿•åº¦ï¼š{humd}%
ğŸŒ¬ï¸ é¢¨é€Ÿï¼š{wind} m/s
â˜” é™é›¨ï¼š{rain} mm
ğŸ•’ è§€æ¸¬æ™‚é–“ï¼š{time}
        """

        outfit = get_outfit_suggestion(temp, rain, wind)

    return weather_info, outfit

# --- Streamlit äº’å‹•éƒ¨åˆ† ---
st.title("ç©¿æ­æ°£è±¡å°å¹«æ‰‹ ğŸ‘•ğŸŒ¦ï¸")
city = st.text_input("è«‹è¼¸å…¥ç¸£å¸‚ï¼ˆä¾‹å¦‚ï¼šæ–°åŒ—å¸‚ï¼‰ï¼š").replace("å°åŒ—", "è‡ºåŒ—")
town = st.text_input("è«‹è¼¸å…¥è¡Œæ”¿å€ï¼ˆä¾‹å¦‚ï¼šä¸‰é‡å€ï¼‰ï¼š")

if st.button("æŸ¥è©¢"):
    st.write("â³ æŸ¥è©¢ä¸­...")
    weather_info, suggestion = get_weather_and_suggestion(city, town)
    st.subheader("ğŸ“ æ°£è±¡è³‡è¨Š")
    st.write(weather_info)
    st.subheader("ğŸ§¥ ç©¿æ­å»ºè­°")
    st.write(suggestion)